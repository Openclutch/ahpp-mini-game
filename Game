<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garden Duo â€” 2D Coâ€‘op Browser Game</title>
  <style>
    html, body { height: 100%; margin: 0; background:#dfeee3; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #wrap { display:flex; flex-direction:column; height:100%; }
    header { background:#20303c; color:#fff; padding:8px 12px; font-weight:600; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    header .pill { background:#2f4656; padding:4px 8px; border-radius:999px; font-weight:600; }
    header .hint { opacity:.9; font-weight:400; }
    header button { border:1px solid #1a2730; background:#2f4656; color:#e8f6ff; border-radius:999px; padding:4px 10px; cursor:pointer; }
    header .savebar { display:flex; gap:8px; align-items:center; margin-left:auto; }
    header .savebar input[type=file]{ display:none; }

    #gameArea { position:relative; flex:1; }
    canvas { width:100%; height:100%; display:block; image-rendering: pixelated; }

    /* Overlay windows */
    .window { position:absolute; top:10px; left:10px; display:flex; gap:10px; }
    .panel { background:#ffffffdd; border:2px solid #333; border-radius:8px; padding:10px; width:190px; }
    .panel h3 { margin:0 0 6px 0; font-size:16px; }
    .panel .row { display:flex; align-items:center; justify-content:space-between; gap:6px; margin:6px 0; }
    .panel button { padding:6px 8px; border-radius:6px; border:1px solid #222; background:#e8f3ff; cursor:pointer; }

    /* Event feed (starts OFFâ€‘SCREEN) */
    #events { position:absolute; right:-380px; top:10px; width:340px; max-width:48vw; background:#ffffffd9; border:2px solid #333; border-radius:8px; padding:8px 10px; transition:right .18s ease-out; }
    #events.open { right:10px; }
    #events h3 { margin:0 0 6px 0; font-size:16px; }
    #feed { max-height:40vh; overflow:auto; font-size:13px; line-height:1.3; }
    .evt { padding:4px 0; border-bottom:1px dashed #ccc; }

    /* Tooltip */
    #tooltip { position:absolute; pointer-events:none; background:#111; color:#fff; padding:4px 6px; border-radius:4px; font-size:12px; transform:translate(-50%, -140%); opacity:0; transition:opacity .08s; white-space:nowrap; }

    /* Footer help */
    footer { background:#20303c; color:#cfe3ff; padding:6px 10px; font-size:14px; display:flex; justify-conte-between; gap:10px; flex-wrap:wrap; }
    footer code { background:#0f1b23; color:#b3e6ff; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="pill" id="p1money">P1 Money: Â¢0</div>
    <div class="pill" id="p2money">P2 Money: Â¢0</div>
    <div class="pill" id="p1hud">P1 Seeds: â€” | Bag: â€”</div>
    <div class="pill" id="p2hud">P2 Seeds: â€” | Bag: â€”</div>
    <button id="toggleEvents" title="Toggle Events (H)">Events</button>
    <div class="savebar">
      <button id="btnSave" title="Save to browser (Autosaves too)">Save</button>
      <button id="btnLoad" title="Load from browser">Load</button>
      <button id="btnExport" title="Download save file">Export</button>
      <button id="btnImport" title="Import save file">Import</button>
      <input id="fileImport" type="file" accept="application/json" />
    </div>
    <div class="hint">Growth persists via timestamps. Rotten plants must be <b>fixed</b> by the plot owner for Â¢10. A random <b>Center Challenge</b> can grant pets with perks.</div>
  </header>
  <div id="gameArea">
    <canvas id="game" width="1280" height="720"></canvas>

    <div class="window" id="vendors">
      <div class="panel" id="shopPanel">
        <h3>Seed Shop</h3>
        <div class="row"><span>Candy Blossom</span><span>Â¢<b id="priceCandy">2</b></span></div>
        <div class="row"><button id="buyCandyP1">Buy P1</button><button id="buyCandyP2">Buy P2</button></div>
        <div class="row"><span>Carrot</span><span>Â¢<b id="priceCarrot">2000</b></span></div>
        <div class="row"><button id="buyCarrotP1">Buy P1</button><button id="buyCarrotP2">Buy P2</button></div>
        <div style="font-size:12px;opacity:.8;">Stand in the shop & press your <b>Action</b> key (P1:<code>E</code>, P2:<code>/</code>) to toggle this UI.</div>
      </div>
      <div class="panel" id="sellPanel">
        <h3>Sell Harvest</h3>
        <div id="sellInfo" style="font-size:13px;">Stand at the Sell booth and press Action to sell everything in your bag.</div>
      </div>
    </div>

    <div id="events">
      <h3>Events</h3>
      <div id="feed"></div>
    </div>

    <div id="tooltip"></div>
  </div>
  <footer>
    <div>
      <b>Controls:</b> P1 <code>WASD</code> move, <code>Q</code> cycle seed, <code>E</code> action. 
      P2 <code>Arrows</code> move, <code>.</code> cycle seed, <code>/</code> action. <b>H</b> toggles Events panel.
    </div>
    <div>
      Plant on your own plots. If a plant rots, the owner can fix the plot for Â¢10. Complete center challenges to earn pets (perks!).
    </div>
  </footer>
</div>

<script>
(() => {
  // ---------- CONFIG ----------
  const PRICES = { candy: 2, carrot: 2000 }; // cents
  const CROPS = {
    candy: { name: 'Candy Blossom', growMs: 60_000, sell: 6 }, // 1 min, sells for 6Â¢
    carrot: { name: 'Carrot', growMs: 600_000, sell: 3000 }    // 10 min, sells for 3000Â¢
  };
  const REPAIR_COST = 10; // cents
  // PETS (one active perk per player)
  const PETS = [
    { id:'bee',    name:'Honey Bee',  emoji:'ðŸ', priceMult:1.10 },
    { id:'bunny',  name:'Bunny',      emoji:'ðŸ°', speed:+0.4 },
    { id:'sprout', name:'Sprout',     emoji:'ðŸŒ±', plantGrowth:1.10 },
  ];

  // Stable save key + migrate from legacy
  const SAVE_KEY = 'garden-duo-main';
  const LEGACY_KEYS = ['garden-duo-v1','garden-duo-v2','garden-duo-v3'];

  // Random plant mutations
  const MUTATIONS = [
    { id:'swift',   label:'Swift Growth', effect:p=>p.growMs*=0.7, rarity:0.15 },
    { id:'giant',   label:'Giant Yield',  effect:p=>p.yield=2,     rarity:0.10 },
    { id:'glitter', label:'Glitter Value',effect:p=>p.sellMult=2,  rarity:0.05 },
    { id:'rot',     label:'Rot-Prone',    effect:p=>p.rotChance=0.25, rarity:0.06 },
  ];

  // World events
  const WORLD_EVENTS = [
    { id:'rain',   label:'Rain! Growth +50% for 30s',  dur:30_000, apply:s=>{s.growthMult*=1.5;} },
    { id:'drought',label:'Heatwave! Growth -30% for 30s', dur:30_000, apply:s=>{s.growthMult*=0.7;} },
    { id:'boom',   label:'Market Boom! Prices +50% for 30s', dur:30_000, apply:s=>{s.priceMult*=1.5;} },
    { id:'slump',  label:'Market Slump! Prices -30% for 30s', dur:30_000, apply:s=>{s.priceMult*=0.7;} },
  ];

  // ---------- STATE ----------
  const state = {
    priceMult: 1,
    growthMult: 1,
    plots: [],
    p1: { x: 220, y: 450, w:20, h:20, speedBase:2.4, money:10, invSeeds:{candy:0,carrot:0}, bag:{candy:0,carrot:0}, selected:'candy', pet:null, pets:[] },
    p2: { x: 1060, y: 450, w:20, h:20, speedBase:2.4, money:10, invSeeds:{candy:0,carrot:0}, bag:{candy:0,carrot:0}, selected:'candy', pet:null, pets:[] },
    shopOpen:false, sellOpen:false,
    activeEvent:null, eventUntil:0,
    // Center challenge
    challenge:null,
  };

  // ---------- SAVE/LOAD ----------
  function migrateLegacy(){
    if (localStorage.getItem(SAVE_KEY)) return;
    for (const k of LEGACY_KEYS){ const v = localStorage.getItem(k); if (v){ localStorage.setItem(SAVE_KEY, v); console.info('Migrated save from', k); break; } }
  }
  migrateLegacy();

  try {
    const saved = JSON.parse(localStorage.getItem(SAVE_KEY)||'null');
    if (saved) {
      Object.assign(state, saved, { shopOpen:false, sellOpen:false });
      state.p1.money ??= 10; state.p2.money ??= 10;
      state.p1.pet??=null; state.p2.pet??=null;
      state.p1.pets??=[]; state.p2.pets??=[];
    }
  } catch {}

  function save() {
    const minimal = JSON.parse(JSON.stringify({
      priceMult: state.priceMult,
      growthMult: state.growthMult,
      plots: state.plots,
      p1: { money:state.p1.money, invSeeds:state.p1.invSeeds, bag:state.p1.bag, pet:state.p1.pet, pets:state.p1.pets },
      p2: { money:state.p2.money, invSeeds:state.p2.invSeeds, bag:state.p2.bag, pet:state.p2.pet, pets:state.p2.pets },
    }));
    localStorage.setItem(SAVE_KEY, JSON.stringify(minimal));
  }
  // Autosave + on close
  setInterval(save, 10_000);
  window.addEventListener('beforeunload', save);

  // ---------- DOM ----------
  const p1moneyEl = document.getElementById('p1money');
  const p2moneyEl = document.getElementById('p2money');
  const p1hud = document.getElementById('p1hud');
  const p2hud = document.getElementById('p2hud');
  const feed = document.getElementById('feed');
  const tooltip = document.getElementById('tooltip');
  const eventsPanel = document.getElementById('events');
  const toggleBtn = document.getElementById('toggleEvents');
  const btnSave = document.getElementById('btnSave');
  const btnLoad = document.getElementById('btnLoad');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const fileImport = document.getElementById('fileImport');

  const buyCandyP1 = document.getElementById('buyCandyP1');
  const buyCandyP2 = document.getElementById('buyCandyP2');
  const buyCarrotP1 = document.getElementById('buyCarrotP1');
  const buyCarrotP2 = document.getElementById('buyCarrotP2');
  const shopPanel = document.getElementById('shopPanel');
  const sellPanel = document.getElementById('sellPanel');

  function log(msg) {
    const d = document.createElement('div');
    d.className='evt'; d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    feed.prepend(d);
    while (feed.childElementCount>60) feed.lastChild.remove();
  }

  // Manual save/load/export/import
  btnSave.onclick = () => { save(); log('Game saved to browser.'); };
  btnLoad.onclick = () => {
    const saved = JSON.parse(localStorage.getItem(SAVE_KEY)||'null');
    if (!saved) { log('No browser save found.'); return; }
    Object.assign(state, saved, { shopOpen:false, sellOpen:false });
    log('Save loaded from browser.');
  };
  btnExport.onclick = () => {
    save();
    const blob = new Blob([localStorage.getItem(SAVE_KEY)||'{}'], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'garden_duo_save.json'; a.click(); URL.revokeObjectURL(a.href);
    log('Exported save file.');
  };
  btnImport.onclick = () => fileImport.click();
  fileImport.onchange = async (e) => {
    const f = e.target.files[0]; if (!f) return;
    try { const txt = await f.text(); const data = JSON.parse(txt); localStorage.setItem(SAVE_KEY, JSON.stringify(data)); Object.assign(state, data, { shopOpen:false, sellOpen:false }); log('Imported save file.'); }
    catch { log('Failed to import save.'); }
  };

  // ---------- WORLD LAYOUT ----------
  const cv = document.getElementById('game');
  const ctx = cv.getContext('2d');
  const WORLD = { w: cv.width, h: cv.height };

  const VENDORS = {
    shop: { x: 20, y: 20, w: 160, h: 120 },
    sell: { x: 200, y: 20, w: 160, h: 120 },
  };

  const GARDENS = [
    { x: 40,  y: 220, w: 320, h: 360, cols:5, rows:4, owner:'P1' },
    { x: WORLD.w-360, y: 220, w: 320, h: 360, cols:5, rows:4, owner:'P2' },
  ];

  if (!state.plots || !state.plots.length) {
    for (const g of GARDENS) {
      const cellW = Math.floor(g.w / g.cols);
      const cellH = Math.floor(g.h / g.rows);
      for (let r=0;r<g.rows;r++) for (let c=0;c<g.cols;c++) {
        state.plots.push({
          x: g.x + c*cellW + 6,
          y: g.y + r*cellH + 6,
          w: cellW - 12,
          h: cellH - 12,
          owner: g.owner,
          crop:null,
        });
      }
    }
  }

  for (const pl of state.plots) { if (!pl.owner) pl.owner = (pl.x < WORLD.w/2 ? 'P1' : 'P2'); }

  // ---------- INPUT ----------
  const keys = new Set();
  window.addEventListener('keydown', e=>{ keys.add(e.code); if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space"].includes(e.code)) e.preventDefault(); });
  window.addEventListener('keyup', e=>{ keys.delete(e.code); });

  function movePlayer(p, up, left, down, right) {
    const sp = p.speedBase + (p.pet && p.pet.id==='bunny' ? (PETS.find(x=>x.id==='bunny').speed||0) : 0);
    if (keys.has(up)) p.y -= sp;
    if (keys.has(down)) p.y += sp;
    if (keys.has(left)) p.x -= sp;
    if (keys.has(right)) p.x += sp;
    p.x = Math.max(0, Math.min(WORLD.w-p.w, p.x));
    p.y = Math.max(0, Math.min(WORLD.h-p.h, p.y));
  }

  const pressed = new Set();
  function justPressed(code) {
    const has = keys.has(code);
    const once = has && !pressed.has(code);
    if (once) pressed.add(code);
    if (!has) pressed.delete(code);
    return once;
  }

  // ---------- GAMEPLAY ----------
  function inside(ax,ay,aw,ah, bx,by,bw,bh){
    return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
  }
  function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }

  function playerByName(name){ return name==='P1' ? state.p1 : state.p2; }

  function playerAction(p, who) {
    // Vendors
    if (inside(p.x,p.y,p.w,p.h, VENDORS.shop.x,VENDORS.shop.y,VENDORS.shop.w,VENDORS.shop.h)) {
      state.shopOpen = !state.shopOpen; state.sellOpen = false; log(`${who} toggled Seed Shop.`); return;
    }
    if (inside(p.x,p.y,p.w,p.h, VENDORS.sell.x,VENDORS.sell.y,VENDORS.sell.w,VENDORS.sell.h)) {
      const sold = sellAll(p);
      if (sold>0) { log(`${who} sold harvest for Â¢${sold}.`); state.sellOpen = true; state.shopOpen=false; }
      else { log(`${who} has nothing to sell.`); state.sellOpen=true; state.shopOpen=false; }
      return;
    }

    // Challenge interaction
    if (state.challenge && Date.now() < state.challenge.endsAt && dist(p.x+p.w/2, p.y+p.h/2, state.challenge.x, state.challenge.y) < state.challenge.r) {
      // Press action to add progress
      state.challenge.progress += 1; log(`${who} pumps the challenge (${state.challenge.progress}/${state.challenge.goal}).`);
      if (state.challenge.progress >= state.challenge.goal) { awardPet(p, who); state.challenge.endsAt = 0; log('Challenge completed!'); }
      return;
    }

    // Plant / harvest / fix / inspect
    const plot = state.plots.find(pl => inside(p.x,p.y,p.w,p.h, pl.x,pl.y,pl.w,pl.h));
    if (!plot) return;

    // Enforce ownership
    if (plot.owner !== who) { log(`${who} can't use that plot â€” it belongs to ${plot.owner}.`); return; }

    if (!plot.crop) {
      const kind = p.selected;
      if (p.invSeeds[kind]>0) {
        p.invSeeds[kind]--;
        plot.crop = createPlant(kind, p); // per-player growth perk applies
        log(`${who} planted ${CROPS[kind].name}${plot.crop.mutation?` (mutation: ${plot.crop.mutation.label})`:''}.`);
        save();
      } else {
        log(`${who} has no ${CROPS[kind].name} seeds. Buy at the shop.`);
      }
      return;
    }

    if (plot.crop.dead) {
      if (p.money >= REPAIR_COST) { p.money -= REPAIR_COST; plot.crop = null; log(`${who} fixed the plot for Â¢${REPAIR_COST}.`); save(); }
      else { log(`${who} needs Â¢${REPAIR_COST} to fix this plot.`); }
      return;
    }

    const st = plantStage(plot.crop);
    if (st>=1) {
      const yld = (plot.crop.yield||1);
      p.bag[plot.crop.kind] = (p.bag[plot.crop.kind]||0) + yld;
      log(`${who} harvested ${yld} Ã— ${CROPS[plot.crop.kind].name}.`);
      plot.crop = null; save();
    } else {
      showTooltip(p, plot);
    }
  }

  function showTooltip(p, pl) {
    let txt = 'Growingâ€¦';
    if (pl.crop && pl.crop.dead) {
      txt = `Rotten. Press Action to fix for Â¢${REPAIR_COST}.`;
    } else if (pl.crop) {
      const c = pl.crop; const st = Math.min(1, plantStage(c));
      const secs = Math.max(0, Math.ceil((1-st) * c.growMs / (state.growthMult*1000)));
      txt = `${CROPS[c.kind].name}: ${(st*100).toFixed(0)}% | ~${secs}s left` + (c.mutation?` | ${c.mutation.label}`:'');
    } else {
      txt = 'Empty plot';
    }
    tooltip.style.left = (p.x + p.w/2) + 'px';
    tooltip.style.top = (p.y) + 'px';
    tooltip.textContent = txt; tooltip.style.opacity=1;
    clearTimeout(showTooltip._t); showTooltip._t = setTimeout(()=>tooltip.style.opacity=0, 1600);
  }

  function createPlant(kind, planter) {
    const base = { kind, plantedAt: Date.now(), growMs: CROPS[kind].growMs, yield:1, sellMult:1, rotChance:0, mutation:null, dead:false };
    // Planter's pet perk
    if (planter && planter.pet && planter.pet.id==='sprout') { base.growMs /= (PETS.find(x=>x.id==='sprout').plantGrowth||1); }
    // Mutation roll
    const roll = Math.random();
    let acc=0; let picked=null;
    for (const m of MUTATIONS) { acc += m.rarity; if (roll < acc) { picked = m; break; } }
    if (picked) { base.mutation = { id:picked.id, label:picked.label }; picked.effect(base); }
    return base;
  }

  function plantStage(crop) {
    if (!crop) return 0;
    if (!crop.dead && crop.rotChance && Math.random()<0.0008) {
      const progress = (Date.now()-crop.plantedAt) / (crop.growMs/state.growthMult);
      if (progress>0.5) { crop.dead = true; log(`Oh no! A plant rotted.`); }
    }
    const elapsed = Date.now() - crop.plantedAt;
    const adjusted = crop.growMs / state.growthMult;
    return Math.min(1, elapsed/adjusted);
  }

  function priceOf(kind, seller) {
    const base = Math.round(CROPS[kind].sell * state.priceMult);
    const petBoost = (seller && seller.pet && seller.pet.id==='bee') ? PETS.find(x=>x.id==='bee').priceMult : 1;
    return Math.round(base * petBoost * (seller && seller.bonusPriceMult || 1));
  }

  function sellAll(p) {
    let total=0; for (const k of Object.keys(CROPS)) {
      const n = p.bag[k]||0; if (!n) continue; const val = n * priceOf(k, p); total += val; p.bag[k]=0;
    }
    p.money += total; save(); return total;
  }

  // Vendor UI buttons
  function tryBuy(who, kind) {
    const target = playerByName(who);
    if (target.money < PRICES[kind]) { log(`${who} canâ€™t afford ${CROPS[kind].name} (Â¢${PRICES[kind]}).`); return; }
    target.money -= PRICES[kind];
    target.invSeeds[kind]++;
    log(`${who} bought 1 Ã— ${CROPS[kind].name} seed.`);
    save();
  }
  buyCandyP1.onclick = ()=>tryBuy('P1','candy');
  buyCandyP2.onclick = ()=>tryBuy('P2','candy');
  buyCarrotP1.onclick = ()=>tryBuy('P1','carrot');
  buyCarrotP2.onclick = ()=>tryBuy('P2','carrot');

  // ---------- WORLD / PET CHALLENGE ----------
  function maybeStartWorldEvent() {
    const now = Date.now();
    if (state.activeEvent && now < state.eventUntil) return;
    if (state.activeEvent) { state.activeEvent = null; state.priceMult = 1; state.growthMult = 1; }
    if (!maybeStartWorldEvent.nextAt) maybeStartWorldEvent.nextAt = now + (45_000 + Math.random()*30_000);
    if (now < maybeStartWorldEvent.nextAt) return;
    const evt = WORLD_EVENTS[Math.floor(Math.random()*WORLD_EVENTS.length)];
    state.activeEvent = evt.id; state.eventUntil = now + evt.dur; evt.apply(state);
    maybeStartWorldEvent.nextAt = now + evt.dur + (40_000 + Math.random()*25_000);
    log(evt.label);
  }

  function maybeSpawnChallenge(){
    const now = Date.now();
    if (state.challenge && now < state.challenge.endsAt) return;
    if (!maybeSpawnChallenge.nextAt) maybeSpawnChallenge.nextAt = now + (50_000 + Math.random()*40_000);
    if (now < maybeSpawnChallenge.nextAt) return;
    state.challenge = { x: WORLD.w/2, y: WORLD.h/2, r: 60, goal: 10, progress:0, endsAt: now + 25_000 };
    maybeSpawnChallenge.nextAt = now + 75_000 + Math.random()*45_000;
    log('Center Challenge appeared! Stand in the circle and press Action to charge it to 10 before time runs out.');
  }

  function awardPet(p, who){
    // Give a random pet not owned, otherwise coins
    const ownedIds = new Set((p.pets||[]).map(x=>x.id));
    const pool = PETS.filter(pt=>!ownedIds.has(pt.id));
    if (pool.length){
      const pet = pool[Math.floor(Math.random()*pool.length)];
      p.pets.push({id:pet.id}); p.pet = {id:pet.id};
      log(`${who} received a pet: ${pet.name}! Perk applied.`);
    } else {
      p.money += 100; log(`${who} already has all pets. Awarded Â¢100 instead.`);
    }
    save();
  }

  // ---------- TEXTURES ----------
  const patterns = {};
  function makeGrassPattern(){
    const c = document.createElement('canvas'); c.width = 64; c.height = 64; const g = c.getContext('2d');
    g.fillStyle = '#9fce9f'; g.fillRect(0,0,64,64);
    for (let i=0;i<120;i++){ g.strokeStyle = 'rgba(30,100,40,0.35)'; g.beginPath(); const x=Math.random()*64, y=Math.random()*64; g.moveTo(x,y); g.lineTo(x+Math.random()*2-1, y-3-Math.random()*3); g.stroke(); }
    g.fillStyle='rgba(255,255,255,.06)'; for (let i=0;i<25;i++){ g.fillRect(Math.random()*64, Math.random()*64, 1, 1); }
    return g.createPattern(c,'repeat');
  }
  function makeSoilPattern(){
    const c = document.createElement('canvas'); c.width = 48; c.height = 48; const g = c.getContext('2d');
    g.fillStyle = '#8b5a2b'; g.fillRect(0,0,48,48);
    g.fillStyle = '#6b3d16'; for (let i=0;i<90;i++){ g.fillRect(Math.random()*48, Math.random()*48, 1, 1); }
    g.fillStyle = '#a7713a'; for (let i=0;i<40;i++){ g.globalAlpha=0.25; g.beginPath(); g.arc(Math.random()*48, Math.random()*48, Math.random()*1.2, 0, Math.PI*2); g.fill(); g.globalAlpha=1; }
    return g.createPattern(c,'repeat');
  }
  patterns.grass = makeGrassPattern();
  patterns.soil = makeSoilPattern();

  // ---------- RENDER ----------
  function draw() {
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.fillStyle = patterns.grass; ctx.fillRect(0,0,cv.width,cv.height);

    // Vendors
    drawVendor(VENDORS.shop, 'Seed Shop');
    drawVendor(VENDORS.sell, 'Sell');

    // Garden rectangles
    for (const gdn of GARDENS) {
      ctx.fillStyle = 'rgba(0,0,0,0.15)';
      ctx.fillRect(gdn.x+2, gdn.y+2, gdn.w, gdn.h);
      ctx.fillStyle = '#7fb07f'; ctx.fillRect(gdn.x, gdn.y, gdn.w, gdn.h);
      ctx.strokeStyle = '#234'; ctx.lineWidth = 3; ctx.strokeRect(gdn.x, gdn.y, gdn.w, gdn.h);
      ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.font='bold 22px sans-serif';
      ctx.fillText(gdn.owner, gdn.x+8, gdn.y+26);
    }

    // Plots
    for (const pl of state.plots) drawPlot(pl);

    // Center challenge circle
    if (state.challenge && Date.now() < state.challenge.endsAt){
      const ch = state.challenge; const rem = Math.max(0, Math.ceil((ch.endsAt-Date.now())/1000));
      ctx.beginPath(); ctx.arc(ch.x, ch.y, ch.r, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.fill();
      ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 3; ctx.stroke();
      // progress wedge
      const p = ch.progress / ch.goal; ctx.beginPath(); ctx.moveTo(ch.x, ch.y); ctx.arc(ch.x, ch.y, ch.r, -Math.PI/2, -Math.PI/2 + Math.PI*2*p);
      ctx.closePath(); ctx.fillStyle = 'rgba(59,130,246,0.4)'; ctx.fill();
      ctx.fillStyle = '#111'; ctx.font='16px sans-serif'; ctx.fillText(`Challenge: ${ch.progress}/${ch.goal}  (${rem}s)`, ch.x-90, ch.y- ch.r - 10);
    }

    // Players
    drawPlayer(state.p1, '#2563eb');
    drawPlayer(state.p2, '#e11d48');

    // HUD
    p1moneyEl.textContent = `P1 Money: Â¢${state.p1.money}`;
    p2moneyEl.textContent = `P2 Money: Â¢${state.p2.money}`;
    const petName1 = state.p1.pet ? PETS.find(p=>p.id===state.p1.pet.id)?.name : 'â€”';
    const petName2 = state.p2.pet ? PETS.find(p=>p.id===state.p2.pet.id)?.name : 'â€”';
    p1hud.textContent = `P1 Seeds: ðŸ¬${state.p1.invSeeds.candy} ðŸ¥•${state.p1.invSeeds.carrot} | Bag: ðŸ¬${state.p1.bag.candy||0} ðŸ¥•${state.p1.bag.carrot||0} | Pet: ${petName1} | Selected: ${CROPS[state.p1.selected].name}`;
    p2hud.textContent = `P2 Seeds: ðŸ¬${state.p2.invSeeds.candy} ðŸ¥•${state.p2.invSeeds.carrot} | Bag: ðŸ¬${state.p2.bag.candy||0} ðŸ¥•${state.p2.bag.carrot||0} | Pet: ${petName2} | Selected: ${CROPS[state.p2.selected].name}`;

    // Panels visibility
    shopPanel.style.display = state.shopOpen? 'block':'none';
    sellPanel.style.display = state.sellOpen? 'block':'none';

    // World event banner
    if (state.activeEvent) {
      ctx.fillStyle = '#0008'; ctx.fillRect(cv.width/2-170, 14, 340, 30);
      ctx.fillStyle = '#fff'; ctx.font = '16px sans-serif';
      const label = WORLD_EVENTS.find(e=>e.id===state.activeEvent)?.label || 'â€”';
      ctx.fillText(label, cv.width/2-160, 34);
    }
  }

  function drawVendor(v, label) {
    ctx.fillStyle = '#f8f2d0'; ctx.fillRect(v.x, v.y, v.w, v.h);
    ctx.strokeStyle = '#333'; ctx.lineWidth = 3; ctx.strokeRect(v.x, v.y, v.w, v.h);
    ctx.fillStyle = '#111'; ctx.font = '16px sans-serif'; ctx.fillText(label, v.x+10, v.y+24);
  }

  function drawPlot(pl) {
    ctx.fillStyle = patterns.soil; ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
    ctx.strokeStyle = '#4b2e12'; ctx.lineWidth = 2; ctx.strokeRect(pl.x, pl.y, pl.w, pl.h);
    ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 1;
    for (let i=1;i<4;i++){ const yy = pl.y + (pl.h*i/4); ctx.beginPath(); ctx.moveTo(pl.x+3, yy); ctx.lineTo(pl.x+pl.w-3, yy); ctx.stroke(); }

    // Owner badge corner
    ctx.fillStyle = pl.owner==='P1' ? 'rgba(37,99,235,.25)' : 'rgba(225,29,72,.25)';
    ctx.fillRect(pl.x, pl.y, 10, 10);

    if (!pl.crop) return;
    const c = pl.crop; const st = plantStage(c);
    if (c.dead) { ctx.fillStyle = 'rgba(40,20,10,0.65)'; ctx.fillRect(pl.x+4, pl.y+4, pl.w-8, pl.h-8); return; }

    let scale = 1; if (c.yield===2) scale *= 1.15;
    if (c.kind==='candy') drawCandyPlant(pl, st, scale, !!c.mutation && c.mutation.id==='glitter');
    else drawCarrotPlant(pl, st, scale);
  }

  function drawCandyPlant(pl, st, scale, glitter){
    const cx = pl.x + pl.w/2; const cy = pl.y + pl.h - 6; 
    const stemH = Math.max(6, st*(pl.h-14)) * scale;
    ctx.strokeStyle = '#2c6e3f'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx, cy-stemH); ctx.stroke();
    ctx.fillStyle = '#3f9958'; for (let i=0;i<3;i++){ ctx.beginPath(); ctx.ellipse(cx-6+i*6, cy-stemH*0.6 - i*3, 8, 3, i*0.7, 0, Math.PI*2); ctx.fill(); }
    const r = 6 + st*6 * scale; const bx = cx, by = cy-stemH-2;
    ctx.fillStyle = '#b06bd3';
    for (let i=0;i<6;i++){ ctx.beginPath(); ctx.ellipse(bx+Math.cos(i)*r, by+Math.sin(i)*r, 6, 10, i, 0, Math.PI*2); ctx.fill(); }
    ctx.fillStyle = '#ffd1e6'; ctx.beginPath(); ctx.arc(bx, by, 5, 0, Math.PI*2); ctx.fill();
    if (glitter){ for (let i=0;i<5;i++){ ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.fillRect(bx+Math.cos(i*2)*r*1.2, by+Math.sin(i*2)*r*1.2, 1, 1); } }
  }

  function drawCarrotPlant(pl, st, scale){
    const cx = pl.x + pl.w/2; const baseY = pl.y + pl.h - 6;
    const top = Math.max(8, st*(pl.h-14)) * scale;
    ctx.strokeStyle = '#2f8a3a'; ctx.lineWidth = 2;
    for (let i=0;i<5;i++){ ctx.beginPath(); ctx.moveTo(cx, baseY-top); ctx.lineTo(cx-14+i*7, baseY-top-10-Math.random()*6); ctx.stroke(); }
    const vis = Math.min(1, st*1.2);
    ctx.fillStyle = '#e67e22';
    ctx.beginPath(); ctx.moveTo(cx, baseY-4 - vis*18);
    ctx.lineTo(cx-10*scale, baseY-4);
    ctx.lineTo(cx+10*scale, baseY-4);
    ctx.closePath(); ctx.fill();
  }

  function drawPlayer(p, color) {
    ctx.fillStyle = color; ctx.fillRect(p.x, p.y, p.w, p.h);
    // pet icon that follows
    if (p.pet){ const pet = PETS.find(pt=>pt.id===p.pet.id); if (pet){ ctx.font='16px sans-serif'; ctx.fillText(pet.emoji, p.x-12, p.y-6); } }
    ctx.fillStyle = '#0007'; ctx.fillRect(p.x-2, p.y-18, 24, 14);
    ctx.fillStyle = '#fff'; ctx.font='12px sans-serif';
    ctx.fillText(p.selected==='candy'?'ðŸ¬':'ðŸ¥•', p.x+3, p.y-6);
  }

  // ---------- MAIN LOOP ----------
  function tick() {
    movePlayer(state.p1, 'KeyW','KeyA','KeyS','KeyD');
    movePlayer(state.p2, 'ArrowUp','ArrowLeft','ArrowDown','ArrowRight');

    if (justPressed('KeyE')) playerAction(state.p1, 'P1');
    if (justPressed('Slash')) playerAction(state.p2, 'P2');

    if (justPressed('KeyQ')) state.p1.selected = (state.p1.selected==='candy'?'carrot':'candy');
    if (justPressed('Period')) state.p2.selected = (state.p2.selected==='candy'?'carrot':'candy');

    if (justPressed('KeyH')) eventsPanel.classList.toggle('open');

    if (!inside(state.p1.x,state.p1.y,state.p1.w,state.p1.h, VENDORS.shop.x,VENDORS.shop.y,VENDORS.shop.w,VENDORS.shop.h) &&
        !inside(state.p2.x,state.p2.y,state.p2.w,state.p2.h, VENDORS.shop.x,VENDORS.shop.y,VENDORS.shop.w,VENDORS.shop.h)) {
      state.shopOpen = false;
    }
    if (!inside(state.p1.x,state.p1.y,state.p1.w,state.p1.h, VENDORS.sell.x,VENDORS.sell.y,VENDORS.sell.w,VENDORS.sell.h) &&
        !inside(state.p2.x,state.p2.y,state.p2.w,state.p2.h, VENDORS.sell.x,VENDORS.sell.y,VENDORS.sell.w,VENDORS.sell.h)) {
      state.sellOpen = false;
    }

    maybeStartWorldEvent();
    maybeSpawnChallenge();
    draw();
    requestAnimationFrame(tick);
  }

  // Init
  document.getElementById('priceCandy').textContent = PRICES.candy;
  document.getElementById('priceCarrot').textContent = PRICES.carrot;
  toggleBtn.onclick = () => eventsPanel.classList.toggle('open');

  if (!localStorage.getItem(SAVE_KEY)) {
    log('Welcome! Buy seeds at the Seed Shop (top-left).');
    log('Plant on your OWN plots. If a plant rots, fix the plot for Â¢10.');
    log('Growth persists from timestamps. Use Save/Load or Export/Import to back up progress.');
  } else {
    log('Save loaded from previous session.');
  }
  tick();
})();
</script>
</body>
</html>
